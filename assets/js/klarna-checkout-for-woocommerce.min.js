jQuery(function(a){if("undefined"==typeof kco_params)return!1;var t={bodyEl:a("body"),checkoutFormSelector:a("form.checkout"),orderNotesValue:"",orderNotesSelector:"textarea#order_comments",orderNotesEl:a("textarea#order_comments"),paymentMethodEl:a('input[name="payment_method"]'),paymentMethod:"",selectAnotherSelector:"#klarna-checkout-select-other",shippingUpdated:!1,blocked:!1,emailExists:kco_params.email_exists,preventPaymentMethodChange:!1,documentReady:function(){t.log(kco_params),0<t.paymentMethodEl.length?t.paymentMethod=t.paymentMethodEl.filter(":checked").val():t.paymentMethod="kco",t.moveExtraCheckoutFields(),t.confirmLoading(),t.kcoResume()},kcoSuspend:function(o){window._klarnaCheckout&&window._klarnaCheckout(function(e){e.suspend({autoResume:{enabled:o}})})},kcoResume:function(){window._klarnaCheckout&&window._klarnaCheckout(function(e){!1===t.blocked&&e.resume()})},confirmLoading:function(){a("#kco-confirm-loading").css("minHeight","300px").block({message:null,overlayCSS:{background:"#fff",opacity:.6}})},updateCart:function(){t.kcoSuspend(!0),a.ajax({type:"POST",url:kco_params.update_cart_url,data:{checkout:a("form.checkout").serialize(),nonce:kco_params.update_cart_nonce},dataType:"json",success:function(e){},error:function(e){},complete:function(e){a("body").trigger("update_checkout"),t.kcoResume()}})},updateKlarnaOrder:function(){"kco"===t.paymentMethod&&"no"===kco_params.is_confirmation_page&&(t.kcoSuspend(),a(".woocommerce-checkout-review-order-table").block({message:null,overlayCSS:{background:"#fff",opacity:.6}}),a.ajax({type:"POST",url:kco_params.update_klarna_order_url,data:{nonce:kco_params.update_klarna_order_nonce},dataType:"json",success:function(e){},error:function(e){},complete:function(e){!0===e.responseJSON.success?(t.kcoResume(),a(".woocommerce-checkout-review-order-table").unblock()):""!==e.responseJSON.data.redirect_url&&(console.log("Cart do not need payment. Reloading checkout."),window.location.href=e.responseJSON.data.redirect_url)}}))},maybeDisplayShippingPrice:function(){if("kco"===t.paymentMethod&&"yes"===kco_params.shipping_methods_in_iframe&&"no"===kco_params.is_confirmation_page)if(jQuery("#shipping_method input[type='radio']").length)a("#shipping_method input[type='radio']:checked").each(function(){var e=a(this).attr("id"),o=a("label[for='"+e+"']").text();a(".woocommerce-shipping-totals td").html(o)});else{var e=a("#shipping_method input[name='shipping_method[0]']").attr("id"),o=a("label[for='"+e+"']").text();a(".woocommerce-shipping-totals td").html(o)}},changeFromKco:function(e){e.preventDefault(),a(t.checkoutFormSelector).block({message:null,overlayCSS:{background:"#fff",opacity:.6}}),a.ajax({type:"POST",dataType:"json",data:{kco:!1,nonce:kco_params.change_payment_method_nonce},url:kco_params.change_payment_method_url,success:function(e){},error:function(e){},complete:function(e){t.log(e.responseJSON),window.location.href=e.responseJSON.data.redirect}})},maybeChangeToKco:function(){t.preventPaymentMethodChange||(t.log(a(this).val()),"kco"===a(this).val()&&(a(".woocommerce-info").remove(),a(t.checkoutFormSelector).block({message:null,overlayCSS:{background:"#fff",opacity:.6}}),a.ajax({type:"POST",data:{kco:!0,nonce:kco_params.change_payment_method_nonce},dataType:"json",url:kco_params.change_payment_method_url,success:function(e){},error:function(e){},complete:function(e){t.log(e.responseJSON),window.location.href=e.responseJSON.data.redirect}})))},log:function(e){kco_params.logging&&console.log(e)},maybeSuspendIframe:function(e){if(!0===e)t.blocked=!1,a("#kco-required-fields-notice").remove(),t.kcoResume();else if(!a("#kco-required-fields-notice").length){t.blocked=!0,a("form.checkout").prepend('<div id="kco-required-fields-notice" class="woocommerce-NoticeGroup woocommerce-NoticeGroup-updateOrderReview"><ul class="woocommerce-error" role="alert"><li>'+kco_params.required_fields_text+"</li></ul></div>");var o=a("form.checkout").offset().top;a("html, body").animate({scrollTop:o},1e3),t.kcoSuspend(!1)}},moveExtraCheckoutFields:function(){a(".woocommerce-additional-fields").appendTo("#kco-extra-checkout-fields");var e=a('form[name="checkout"] input, form[name="checkout"] select, textarea');for(i=0;i<e.length;i++){var o=e[i].name;-1===a.inArray(o,kco_params.standard_woo_checkout_fields)&&(0<a("p#"+o+"_field").length?a("p#"+o+"_field").appendTo("#kco-extra-checkout-fields"):a('input[name="'+o+'"]').closest("p").appendTo("#kco-extra-checkout-fields"))}},getKlarnaOrder:function(){t.kcoSuspend(),t.preventPaymentMethodChange=!0,a(".woocommerce-checkout-review-order-table").block({message:null,overlayCSS:{background:"#fff",opacity:.6}}),a.ajax({type:"POST",url:kco_params.get_klarna_order_url,data:{nonce:kco_params.get_klarna_order_nonce},dataType:"json",success:function(e){},error:function(e){return!1},complete:function(e){return t.setCustomerData(e.responseJSON.data),0<a("form.checkout #terms").length&&a("form.checkout #terms").prop("checked",!0),a("form.checkout").submit(),!0}})},hashChange:function(){-1<location.hash.indexOf("#klarna-success")&&a("body").trigger("kco_order_validation",!0)},errorDetected:function(){a("body").trigger("kco_order_validation",!1)},setCustomerData:function(e){console.log(e),a("#billing_first_name").val(e.billing_address.given_name),a("#billing_last_name").val(e.billing_address.family_name),a("#billing_address_1").val(e.billing_address.street_address),a("#billing_address_2").val(e.billing_address.street_address2?e.billing_address.street_address2:""),a("#billing_city").val(e.billing_address.city),a("#billing_postcode").val(e.billing_address.postal_code),a("#billing_phone").val(e.billing_address.phone),a("#billing_email").val(e.billing_address.email),a("#billing_country").val(e.billing_address.country.toUpperCase()),a("#billing_state").val(e.billing_address.region?e.billing_address.region:""),a("#shipping_first_name").val(e.shipping_address.given_name),a("#shipping_last_name").val(e.shipping_address.family_name),a("#shipping_address_1").val(e.shipping_address.street_address),a("#shipping_address_2").val(e.shipping_address.street_address2?e.shipping_address.street_address2:""),a("#shipping_city").val(e.shipping_address.city),a("#shipping_postcode").val(e.shipping_address.postal_code),a("#shipping_country").val(e.shipping_address.country.toUpperCase()),a("#shipping_state").val(e.shipping_address.region?e.shipping_address.region:"")},init:function(){a(document).ready(t.documentReady),t.bodyEl.on("update_checkout",t.kcoSuspend(!0)),t.bodyEl.on("updated_checkout",t.updateKlarnaOrder),t.bodyEl.on("updated_checkout",t.maybeDisplayShippingPrice),t.bodyEl.on("updated_checkout",t.maybePrintValidationMessage),t.bodyEl.on("change","input.qty",t.updateCart),t.bodyEl.on("change",'input[name="payment_method"]',t.maybeChangeToKco),t.bodyEl.on("click",t.selectAnotherSelector,t.changeFromKco),a(window).on("hashchange",t.hashChange),a(document.body).on("checkout_error",t.errorDetected),"function"==typeof window._klarnaCheckout&&window._klarnaCheckout(function(e){e.on({shipping_address_change:function(e){t.log("shipping_address_change"),t.log(e),a(".woocommerce-checkout-review-order-table").block({message:null,overlayCSS:{background:"#fff",opacity:.6}}),t.kcoSuspend(!0),a.ajax({url:kco_params.iframe_shipping_address_change_url,type:"POST",dataType:"json",data:{data:e,nonce:kco_params.iframe_shipping_address_change_nonce},success:function(e){t.log(e),t.setCustomerData(e.data),t.kcoResume(),a("body").trigger("update_checkout")},error:function(e){t.log(e)},complete:function(e){a(".woocommerce-checkout-review-order-table").unblock(),t.shippingUpdated=!0,t.bodyEl.trigger("kco_shipping_address_changed",e)}})},change:function(e){t.log("change",e)},order_total_change:function(e){t.log("order_total_change",e)},shipping_option_change:function(o){t.log("shipping_option_change",o),t.log(o),a(".woocommerce-checkout-review-order-table").block({message:null,overlayCSS:{background:"#fff",opacity:.6}}),t.kcoSuspend(!0),a.ajax({url:kco_params.update_shipping_url,type:"POST",dataType:"json",data:{data:o,nonce:kco_params.update_shipping_nonce},success:function(e){t.log(e),a("body").trigger("update_checkout")},error:function(e){t.log(e)},complete:function(e){a("#shipping_method #"+e.responseJSON.data.shipping_option_name).prop("checked",!0),a("body").trigger("kco_shipping_option_changed",[o]),a(".woocommerce-checkout-review-order-table").unblock(),t.kcoResume()}})},can_not_complete_order:function(e){t.log("can_not_complete_order",e)},validation_callback:function(e,n){t.getKlarnaOrder(),a("body").on("kco_order_validation",function(e,o){n({should_proceed:o})})}})})}};t.init(),a(document).on("keypress","#kco-order-review .qty",function(e){13==e.keyCode&&e.preventDefault()})});
