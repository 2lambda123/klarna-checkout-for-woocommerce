jQuery(function(d){if("undefined"==typeof kco_params)return!1;var u={bodyEl:d("body"),checkoutFormSelector:"form.checkout",orderNotesValue:"",orderNotesSelector:"textarea#order_comments",orderNotesEl:d("textarea#order_comments"),extraFieldsValues:{},extraFieldsSelectorText:'div#kco-extra-fields input[type="text"], div#kco-extra-fields input[type="password"], div#kco-extra-fields textarea, div#kco-extra-fields input[type="email"], div#kco-extra-fields input[type="tel"]',extraFieldsSelectorNonText:'div#kco-extra-fields select, div#kco-extra-fields input[type="radio"], div#kco-extra-fields input[type="checkbox"], div#kco-extra-fields input.checkout-date-picker, input#terms input[type="checkbox"]',paymentMethodEl:d('input[name="payment_method"]'),paymentMethod:"",selectAnotherSelector:"#klarna-checkout-select-other",formFields:[],documentReady:function(){u.log(kco_params),u.setFormData(),0<u.paymentMethodEl.length?u.paymentMethod=u.paymentMethodEl.filter(":checked").val():u.paymentMethod="kco",u.confirmLoading(),u.setFormFieldValuesFromTransiet()},kcoSuspend:function(){window._klarnaCheckout&&window._klarnaCheckout(function(e){e.suspend()})},kcoResume:function(){window._klarnaCheckout&&window._klarnaCheckout(function(e){e.resume()})},confirmLoading:function(){d("#kco-confirm-loading").css("minHeight","300px").block({message:null,overlayCSS:{background:"#fff",opacity:.6}})},updateCart:function(){u.kcoSuspend(),d.ajax({type:"POST",url:kco_params.update_cart_url,data:{checkout:d("form.checkout").serialize(),nonce:kco_params.update_cart_nonce},dataType:"json",success:function(e){},error:function(e){},complete:function(e){d("body").trigger("update_checkout"),u.kcoResume()}})},updateExtraFields:function(){var t=d(this),a=u.formFields,n=t.attr("name"),c=t.val();d.each(a,function(e,o){o.name===n&&(t.is(":checkbox")&&(t.is(":checked")||(c="")),a[e].value=c)}),u.formFields=a,console.table(u.formFields),u.saveFormData()},updateOrderNotes:function(){u.orderNotesEl.val()!==u.orderNotesValue&&(u.orderNotesValue=u.orderNotesEl.val(),d.ajax({type:"POST",url:kco_params.update_order_notes_url,data:{order_notes:u.orderNotesValue,nonce:kco_params.update_order_notes_nonce},success:function(e){},error:function(e){},complete:function(e){u.log("complete",e)}}))},updateKlarnaOrder:function(){"kco"===u.paymentMethod&&"no"===kco_params.is_confirmation_page&&(d(".woocommerce-checkout-review-order-table").block({message:null,overlayCSS:{background:"#fff",opacity:.6}}),d.ajax({type:"POST",url:kco_params.update_klarna_order_url,data:{nonce:kco_params.update_klarna_order_nonce},dataType:"json",success:function(e){},error:function(e){},complete:function(e){!0===e.responseJSON.success?(u.kcoResume(),d(".woocommerce-checkout-review-order-table").unblock()):""!==e.responseJSON.data.redirect_url&&(console.log("Cart do not need payment. Reloading checkout."),window.location.href=e.responseJSON.data.redirect_url)}}))},changeFromKco:function(e){e.preventDefault(),d(u.checkoutFormSelector).block({message:null,overlayCSS:{background:"#fff",opacity:.6}}),d.ajax({type:"POST",dataType:"json",data:{kco:!1,nonce:kco_params.change_payment_method_nonce},url:kco_params.change_payment_method_url,success:function(e){},error:function(e){},complete:function(e){u.log(e.responseJSON),window.location.href=e.responseJSON.data.redirect}})},maybeChangeToKco:function(){u.log(d(this).val()),"kco"===d(this).val()&&(d(".woocommerce-info").remove(),d(u.checkoutFormSelector).block({message:null,overlayCSS:{background:"#fff",opacity:.6}}),d.ajax({type:"POST",data:{kco:!0,nonce:kco_params.change_payment_method_nonce},dataType:"json",url:kco_params.change_payment_method_url,success:function(e){},error:function(e){},complete:function(e){u.log(e.responseJSON),window.location.href=e.responseJSON.data.redirect}}))},checkoutError:function(){if("kco"===u.paymentMethod&&"yes"===kco_params.is_confirmation_page){var e=d(".woocommerce-NoticeGroup-checkout").text();d.ajax({type:"POST",dataType:"json",data:{kco:!1,error_message:e,nonce:kco_params.checkout_error_nonce},url:kco_params.checkout_error_url,success:function(e){},error:function(e){},complete:function(e){u.log(e.responseJSON),window.location.href=e.responseJSON.data.redirect}})}},log:function(e){kco_params.logging&&console.log(e)},setFormData:function(){var e,o=d('form[name="checkout"] input'),t=[];for(e=0;e<o.length;e++)if(""!==o[e].name){var a=o[e].name,n=d('*[name="'+a+'"]'),c=n.attr("id"),r=d('label[for="'+c+'"]').parents()[0],i=!!d(r).hasClass("validate-required")||"terms"===c;if("-1"==d.inArray(a,kco_params.standard_woo_checkout_fields)&&a.indexOf("[qty]")<0){var s=!1,l=n.is(":checkbox")?n.is(":checked")?o[e].value:"":o[e].value;!0===i&&("terms"===o[e].name&&(l=1===d("input#terms:checked").length?1:""),s=!0),t.push({name:o[e].name,value:l,required:s})}}u.formFields=t,u.saveFormData()},saveFormData:function(){d.ajax({type:"POST",url:kco_params.save_form_data,data:{form:u.formFields,nonce:kco_params.save_form_data_nonce},dataType:"json",success:function(e){},error:function(e){},complete:function(e){}})},setFormFieldValuesFromTransiet:function(){var e=kco_params.form;for(i=0;i<e.length;i++){var o=d('*[name="'+e[i].name+'"]'),t=e[i].value;o.attr("id");o.is(":checkbox")&&""!==t&&o.prop("checked",!0)}},setFieldValues:function(e){d("#billing_email").val(e.email),d("#billing_state").val(e.states.billing_state),d("#shipping_state").val(e.states.shipping_state),d("#billing_email").change(),d("#billing_email").blur()},init:function(){d(document).ready(u.documentReady),u.bodyEl.on("update_checkout",u.kcoSuspend),u.bodyEl.on("updated_checkout",u.updateKlarnaOrder),u.bodyEl.on("checkout_error",u.checkoutError),u.bodyEl.on("change","input.qty",u.updateCart),u.bodyEl.on("blur",u.extraFieldsSelectorText,u.updateExtraFields),u.bodyEl.on("change",u.extraFieldsSelectorNonText,u.updateExtraFields),u.bodyEl.on("change",'input[name="payment_method"]',u.maybeChangeToKco),u.bodyEl.on("click",u.selectAnotherSelector,u.changeFromKco),u.bodyEl.on("click","input#terms",u.setFormData),u.bodyEl.on("click","input#terms",u.updateExtraFields),"function"==typeof window._klarnaCheckout&&window._klarnaCheckout(function(e){e.on({shipping_address_change:function(e){u.log("shipping_address_change"),u.log(e),d(".woocommerce-checkout-review-order-table").block({message:null,overlayCSS:{background:"#fff",opacity:.6}}),u.kcoSuspend(),d.ajax({url:kco_params.iframe_shipping_address_change_url,type:"POST",dataType:"json",data:{data:e,nonce:kco_params.iframe_shipping_address_change_nonce},success:function(e){u.log(e),u.setFieldValues(e.data),d("body").trigger("update_checkout")},error:function(e){u.log(e)},complete:function(){d(".woocommerce-checkout-review-order-table").unblock(),u.kcoResume()}})},change:function(e){u.log("change",e)},order_total_change:function(e){u.log("order_total_change",e)},shipping_option_change:function(e){u.log("shipping_option_change",e)},can_not_complete_order:function(e){u.log("can_not_complete_order",e)}})})}};u.init(),d("body").on("blur",u.setFormData),d(document).on("keypress","#kco-order-review .qty",function(e){13==e.keyCode&&e.preventDefault()})});