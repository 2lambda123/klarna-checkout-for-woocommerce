jQuery(function(r){if("undefined"==typeof kco_params)return!1;var l={bodyEl:r("body"),checkoutFormSelector:"form.checkout",orderNotesValue:"",orderNotesSelector:"textarea#order_comments",orderNotesEl:r("textarea#order_comments"),extraFieldsValues:{},extraFieldsSelectorText:'div#kco-extra-fields input[type="text"], div#kco-extra-fields input[type="password"], div#kco-extra-fields textarea',extraFieldsSelectorNonText:'div#kco-extra-fields select, div#kco-extra-fields input[type="radio"], div#kco-extra-fields input[type="checkbox"], div#kco-extra-fields input.checkout-date-picker',paymentMethodEl:r('input[name="payment_method"]'),paymentMethod:"",selectAnotherSelector:"#klarna-checkout-select-other",formFields:[],documentReady:function(){l.log(kco_params),l.setFormData(),0<l.paymentMethodEl.length?l.paymentMethod=l.paymentMethodEl.filter(":checked").val():l.paymentMethod="kco",l.confirmLoading()},kcoSuspend:function(){window._klarnaCheckout&&window._klarnaCheckout(function(e){e.suspend()})},kcoResume:function(){window._klarnaCheckout&&window._klarnaCheckout(function(e){e.resume()})},confirmLoading:function(){r("#kco-confirm-loading").css("minHeight","300px").block({message:null,overlayCSS:{background:"#fff",opacity:.6}})},updateCart:function(){l.kcoSuspend(),r.ajax({type:"POST",url:kco_params.update_cart_url,data:{checkout:r("form.checkout").serialize(),nonce:kco_params.update_cart_nonce},dataType:"json",success:function(e){},error:function(e){},complete:function(e){r("body").trigger("update_checkout"),l.kcoResume()}})},updateExtraFields:function(){var e=r(this).attr("name"),o=r(this).val();l.log("value"),l.log(o),l.log("name"),l.log(e),l.log(typeof l.extraFieldsValues),l.log(l.extraFieldsValues),null===l.extraFieldsValues&&""===o||null!==l.extraFieldsValues&&e in l.extraFieldsValues&&o===l.extraFieldsValues||(null===l.extraFieldsValues&&(l.extraFieldsValues={}),l.log("update"),l.extraFieldsValues[e]=o,r.ajax({type:"POST",url:kco_params.update_extra_fields_url,data:{extra_fields_values:l.extraFieldsValues,nonce:kco_params.update_extra_fields_nonce},success:function(e){},error:function(e){},complete:function(e){l.log("complete",e)}}))},updateOrderNotes:function(){l.orderNotesEl.val()!==l.orderNotesValue&&(l.orderNotesValue=l.orderNotesEl.val(),r.ajax({type:"POST",url:kco_params.update_order_notes_url,data:{order_notes:l.orderNotesValue,nonce:kco_params.update_order_notes_nonce},success:function(e){},error:function(e){},complete:function(e){l.log("complete",e)}}))},updateKlarnaOrder:function(){"kco"===l.paymentMethod&&r.ajax({type:"POST",url:kco_params.update_klarna_order_url,data:{nonce:kco_params.update_klarna_order_nonce},dataType:"json",success:function(e){},error:function(e){},complete:function(e){l.kcoResume()}})},changeFromKco:function(e){e.preventDefault(),r(l.checkoutFormSelector).block({message:null,overlayCSS:{background:"#fff",opacity:.6}}),r.ajax({type:"POST",dataType:"json",data:{kco:!1,nonce:kco_params.change_payment_method_nonce},url:kco_params.change_payment_method_url,success:function(e){},error:function(e){},complete:function(e){l.log(e.responseJSON),window.location.href=e.responseJSON.data.redirect}})},maybeChangeToKco:function(){l.log(r(this).val()),"kco"===r(this).val()&&(r(".woocommerce-info").remove(),r(l.checkoutFormSelector).block({message:null,overlayCSS:{background:"#fff",opacity:.6}}),r.ajax({type:"POST",data:{kco:!0,nonce:kco_params.change_payment_method_nonce},dataType:"json",url:kco_params.change_payment_method_url,success:function(e){},error:function(e){},complete:function(e){l.log(e.responseJSON),window.location.href=e.responseJSON.data.redirect}}))},checkoutError:function(){if("kco"===l.paymentMethod){var e=r(".woocommerce-NoticeGroup-checkout").text();r.ajax({type:"POST",dataType:"json",data:{kco:!1,error_message:e,nonce:kco_params.checkout_error_nonce},url:kco_params.checkout_error_url,success:function(e){},error:function(e){},complete:function(e){l.log(e.responseJSON),window.location.href=e.responseJSON.data.redirect}})}},log:function(e){kco_params.logging&&console.log(e)},setFormData:function(){var e,o=r('form[name="checkout"] input'),a=[];for(e=0;e<o.length;e++)if(""!==o[e].name){var t=o[e].name,n=r('*[name="'+t+'"]'),c=n.attr("id");!0===!!r('label[for="'+c+'"]').has("abbr").length&&a.push({name:o[e].name,value:n.is(":checkbox")?n.is(":checked")?o[e].value:"":o[e].value,required:!0})}l.formFields=a,l.saveFormData()},saveFormData:function(){console.log(l.formFields),r.ajax({type:"POST",url:kco_params.save_form_data,data:{form:l.formFields,nonce:kco_params.save_form_data_nonce},dataType:"json",success:function(e){},error:function(e){},complete:function(e){console.log("success save thingy")}})},init:function(){r(document).ready(l.documentReady),l.bodyEl.on("update_checkout",l.kcoSuspend),l.bodyEl.on("updated_checkout",l.updateKlarnaOrder),l.bodyEl.on("checkout_error",l.checkoutError),l.bodyEl.on("change","input.qty",l.updateCart),l.bodyEl.on("blur",l.extraFieldsSelectorText,l.setFormData),l.bodyEl.on("change",l.extraFieldsSelectorNonText,l.setFormData),l.bodyEl.on("blur",l.extraFieldsSelectorText,l.updateExtraFields),l.bodyEl.on("change",l.extraFieldsSelectorNonText,l.updateExtraFields),l.bodyEl.on("change",'input[name="payment_method"]',l.maybeChangeToKco),l.bodyEl.on("click",l.selectAnotherSelector,l.changeFromKco),"function"==typeof window._klarnaCheckout&&window._klarnaCheckout(function(e){e.on({shipping_address_change:function(e){l.log("shipping_address_change"),l.log(e),r(".woocommerce-checkout-review-order-table").block({message:null,overlayCSS:{background:"#fff",opacity:.6}}),l.kcoSuspend(),r.ajax({url:kco_params.iframe_shipping_address_change_url,type:"POST",dataType:"json",data:{data:e,nonce:kco_params.iframe_shipping_address_change_nonce},success:function(e){l.log(e),r(".woocommerce-checkout-review-order-table").replaceWith(e.data.html)},error:function(e){l.log(e)},complete:function(){r(".woocommerce-checkout-review-order-table").unblock(),l.kcoResume()}})},change:function(e){l.log("change",e)},order_total_change:function(e){l.log("order_total_change",e)},shipping_option_change:function(e){l.log("shipping_option_change",e)},can_not_complete_order:function(e){l.log("can_not_complete_order",e)}})})}};l.init(),r("body").on("blur",l.setFormData),r(document).on("keypress","#kco-order-review",function(e){13==e.keyCode&&e.preventDefault()})});