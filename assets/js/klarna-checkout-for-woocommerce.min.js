jQuery(function(s){if("undefined"==typeof kco_params)return!1;var d={bodyEl:s("body"),checkoutFormSelector:"form.checkout",orderNotesValue:"",orderNotesSelector:"textarea#order_comments",orderNotesEl:s("textarea#order_comments"),extraFieldsValues:{},extraFieldsSelectorText:'div#kco-extra-fields input[type="text"], div#kco-extra-fields input[type="password"], div#kco-extra-fields textarea, div#kco-extra-fields input[type="email"], div#kco-extra-fields input[type="tel"]',extraFieldsSelectorNonText:'div#kco-extra-fields select, div#kco-extra-fields input[type="radio"], div#kco-extra-fields input[type="checkbox"], div#kco-extra-fields input.checkout-date-picker, input#terms input[type="checkbox"]',paymentMethodEl:s('input[name="payment_method"]'),paymentMethod:"",selectAnotherSelector:"#klarna-checkout-select-other",needsUpdate:!1,documentReady:function(){d.setFormFieldValues(),d.log(kco_params),d.checkFormData(),0<d.paymentMethodEl.length?d.paymentMethod=d.paymentMethodEl.filter(":checked").val():d.paymentMethod="kco",d.confirmLoading()},kcoSuspend:function(){window._klarnaCheckout&&window._klarnaCheckout(function(e){e.suspend()})},kcoResume:function(){window._klarnaCheckout&&window._klarnaCheckout(function(e){e.resume()})},confirmLoading:function(){s("#kco-confirm-loading").css("minHeight","300px").block({message:null,overlayCSS:{background:"#fff",opacity:.6}})},updateCart:function(){d.kcoSuspend(),s.ajax({type:"POST",url:kco_params.update_cart_url,data:{checkout:s("form.checkout").serialize(),nonce:kco_params.update_cart_nonce},dataType:"json",success:function(e){},error:function(e){},complete:function(e){s("body").trigger("update_checkout"),d.kcoResume()}})},updateExtraFields:function(){var t=s(this),a=d.formFields,n=t.attr("name"),c=t.val();s.each(a,function(e,o){o.name===n&&(t.is(":checkbox")&&(t.is(":checked")||(c="")),t.is(":radio ")&&(t.is(":checked")||(c="")),"select-one"===t.prop("type")&&(c=t.find(":selected").val()),a[e].value=c)}),d.formFields=a},updateOrderNotes:function(){d.orderNotesEl.val()!==d.orderNotesValue&&(d.orderNotesValue=d.orderNotesEl.val(),s.ajax({type:"POST",url:kco_params.update_order_notes_url,data:{order_notes:d.orderNotesValue,nonce:kco_params.update_order_notes_nonce},success:function(e){},error:function(e){},complete:function(e){d.log("complete",e)}}))},updateKlarnaOrder:function(){"kco"===d.paymentMethod&&"no"===kco_params.is_confirmation_page&&(s(".woocommerce-checkout-review-order-table").block({message:null,overlayCSS:{background:"#fff",opacity:.6}}),s.ajax({type:"POST",url:kco_params.update_klarna_order_url,data:{nonce:kco_params.update_klarna_order_nonce},dataType:"json",success:function(e){},error:function(e){},complete:function(e){!0===e.responseJSON.success?(d.kcoResume(),s(".woocommerce-checkout-review-order-table").unblock()):""!==e.responseJSON.data.redirect_url&&(console.log("Cart do not need payment. Reloading checkout."),window.location.href=e.responseJSON.data.redirect_url)}}))},maybeDisplayShippingPrice:function(){if("kco"===d.paymentMethod&&"yes"===kco_params.shipping_methods_in_iframe&&"no"===kco_params.is_confirmation_page)if(jQuery("#shipping_method input[type='radio']").length)s("#shipping_method input[type='radio']:checked").each(function(){var e=s(this).attr("id"),o=s("label[for='"+e+"']").text();s(".woocommerce-shipping-totals td").html(o)});else{var e=s("#shipping_method input[name='shipping_method[0]']").attr("id"),o=s("label[for='"+e+"']").text();s(".woocommerce-shipping-totals td").html(o)}},changeFromKco:function(e){e.preventDefault(),s(d.checkoutFormSelector).block({message:null,overlayCSS:{background:"#fff",opacity:.6}}),s.ajax({type:"POST",dataType:"json",data:{kco:!1,nonce:kco_params.change_payment_method_nonce},url:kco_params.change_payment_method_url,success:function(e){},error:function(e){},complete:function(e){d.log(e.responseJSON),window.location.href=e.responseJSON.data.redirect}})},maybeChangeToKco:function(){d.log(s(this).val()),"kco"===s(this).val()&&(s(".woocommerce-info").remove(),s(d.checkoutFormSelector).block({message:null,overlayCSS:{background:"#fff",opacity:.6}}),s.ajax({type:"POST",data:{kco:!0,nonce:kco_params.change_payment_method_nonce},dataType:"json",url:kco_params.change_payment_method_url,success:function(e){},error:function(e){},complete:function(e){d.log(e.responseJSON),window.location.href=e.responseJSON.data.redirect}}))},checkoutError:function(){if("kco"===d.paymentMethod&&"yes"===kco_params.is_confirmation_page){var e=s(".woocommerce-NoticeGroup-checkout").text();s.ajax({type:"POST",dataType:"json",data:{kco:!1,error_message:e,nonce:kco_params.checkout_error_nonce},url:kco_params.checkout_error_url,success:function(e){},error:function(e){},complete:function(e){d.log(e.responseJSON),window.location.href=e.responseJSON.data.redirect}})}},log:function(e){kco_params.logging&&console.log(e)},checkFormData:function(){var e=s('form[name="checkout"] input, form[name="checkout"] select, textarea'),o=[],t={};for(i=0;i<e.length;i++)if(""!==e[i].name){var a=e[i].name,n=s('*[name="'+a+'"]'),c=!!s("p#"+a+"_field").hasClass("validate-required");if("-1"==s.inArray(a,kco_params.standard_woo_checkout_fields)&&a.indexOf("[qty]")<0&&a.indexOf("shipping_method")<0&&a.indexOf("payment_method")<0){!0===c&&o.push(a);var r="";n.is(":checkbox")?n.is(":checked")&&(r=e[i].value):n.is(":radio")?n.is(":checked")&&(r=s('input[name="'+a+'"]:checked').val()):r=e[i].value,t[a]=r}}sessionStorage.setItem("KCORequiredFields",JSON.stringify(o)),sessionStorage.setItem("KCOFieldData",JSON.stringify(t)),d.needsUpdate=!0,d.validateRequiredFields()},validateRequiredFields:function(){var e=JSON.parse(sessionStorage.getItem("KCORequiredFields")),o=JSON.parse(sessionStorage.getItem("KCOFieldData")),t=!0;for(i=0;i<e.length;i++)fieldName=e[i],""===o[fieldName]&&(t=!1);d.updateSession(t)},updateSession:function(e){!1!==d.needsUpdate&&s.ajax({type:"POST",url:kco_params.set_session_value_url,data:{bool:e,nonce:kco_params.set_session_value_nonce},dataType:"json",success:function(e){},error:function(e){},complete:function(e){d.needsUpdate=!1}})},setFormFieldValues:function(){var e=JSON.parse(sessionStorage.getItem("KCOFieldData"));s.each(e,function(e,o){var t=s('*[name="'+e+'"]'),a=o;if(t.is(":checkbox"))""!==a&&t.prop("checked",!0);else if(t.is(":radio"))for(x=0;x<t.length;x++)t[x].value===o&&s(t[x]).prop("checked",!0);else t.val(a)})},init:function(){s(document).ready(d.documentReady),d.bodyEl.on("update_checkout",d.kcoSuspend),d.bodyEl.on("updated_checkout",d.updateKlarnaOrder),d.bodyEl.on("updated_checkout",d.maybeDisplayShippingPrice),d.bodyEl.on("checkout_error",d.checkoutError),d.bodyEl.on("change","input.qty",d.updateCart),d.bodyEl.on("change",'input[name="payment_method"]',d.maybeChangeToKco),d.bodyEl.on("click",d.selectAnotherSelector,d.changeFromKco),d.bodyEl.on("blur",d.extraFieldsSelectorText,d.checkFormData),d.bodyEl.on("change",d.extraFieldsSelectorNonText,d.checkFormData),d.bodyEl.on("click","input#terms",d.checkFormData),"function"==typeof window._klarnaCheckout&&window._klarnaCheckout(function(e){e.on({shipping_address_change:function(e){d.log("shipping_address_change"),d.log(e),s(".woocommerce-checkout-review-order-table").block({message:null,overlayCSS:{background:"#fff",opacity:.6}}),d.kcoSuspend(),s.ajax({url:kco_params.iframe_shipping_address_change_url,type:"POST",dataType:"json",data:{data:e,nonce:kco_params.iframe_shipping_address_change_nonce},success:function(e){d.log(e),s("body").trigger("update_checkout")},error:function(e){d.log(e)},complete:function(){s(".woocommerce-checkout-review-order-table").unblock(),d.kcoResume()}})},change:function(e){d.log("change",e)},order_total_change:function(e){d.log("order_total_change",e)},shipping_option_change:function(e){d.log("shipping_option_change",e),d.log(e),s(".woocommerce-checkout-review-order-table").block({message:null,overlayCSS:{background:"#fff",opacity:.6}}),d.kcoSuspend(),s.ajax({url:kco_params.update_shipping_url,type:"POST",dataType:"json",data:{data:e,nonce:kco_params.update_shipping_nonce},success:function(e){d.log(e),s("body").trigger("update_checkout")},error:function(e){d.log(e)},complete:function(e){s("#shipping_method #"+e.responseJSON.data.shipping_option_name).prop("checked",!0),s("body").trigger("kco_shipping_option_changed"),s(".woocommerce-checkout-review-order-table").unblock(),d.kcoResume()}})},can_not_complete_order:function(e){d.log("can_not_complete_order",e)}})})}};d.init(),s("body").on("blur",d.checkFormData),s(document).on("keypress","#kco-order-review .qty",function(e){13==e.keyCode&&e.preventDefault()}),s(document).ajaxStop(function(){d.validateRequiredFields()})});